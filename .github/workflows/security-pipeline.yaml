name: Security Pipeline

on:
  push:
    branches:
      - main
      - master
      - test
      - "feature/*"
  pull_request:

permissions:
  contents: read
  security-events: write

jobs:
  # 1) SAST - Semgrep
  sast_semgrep:
    name: SAST - Semgrep
    runs-on: ubuntu-latest

    steps:
      - name: Kodu çek
        uses: actions/checkout@v4

      - name: Python kur
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Semgrep yükle
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      - name: Semgrep tara (otomatik kurallar)
        run: |
          semgrep --config auto --sarif --output semgrep.sarif || true

      - name: Semgrep sonuçlarını GitHub Security'e yükle
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif

  # 2) Dependency & filesystem taraması - Trivy FS
  dep_trivy_fs:
    name: Dependency Tarama (Trivy FS)
    runs-on: ubuntu-latest
    needs: sast_semgrep

    steps:
      - name: Kodu çek
        uses: actions/checkout@v4

      - name: Trivy ile container image tara
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: image
          image-ref: juice-shop-app
          format: sarif
          output: trivy-image.sarif
          exit-code: 0


      - name: Trivy FS tara (dosya & bağımlılık)
        run: |
          trivy fs --security-checks vuln,config \
                   --format sarif \
                   --output trivy-fs.sarif .

      - name: Trivy FS sonuçlarını GitHub Security'e yükle
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-fs.sarif

  # 3) Container image build + image scan
  container_scan:
    name: Container Image Tarama (Build + Trivy Image)
    runs-on: ubuntu-latest
    needs: dep_trivy_fs

    steps:
      - name: Kodu çek
        uses: actions/checkout@v4

      - name: Docker imajını oluştur
        run: |
          docker build -t juice-shop-app .

      - name: Trivy ile imaj tara
        run: |
          trivy image --security-checks vuln,config \
                      --format sarif \
                      --output trivy-image.sarif \
                      juice-shop-app || true

      - name: Trivy Image sonuçlarını GitHub Security'e yükle
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-image.sarif

  # 4) Secret taraması - Gitleaks
  secret_scan:
    name: Secret Tarama (Gitleaks)
    runs-on: ubuntu-latest
    needs: sast_semgrep

    steps:
      - name: Kodu çek
        uses: actions/checkout@v4

      - name: Gitleaks çalıştır
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . \
                       --report-format sarif \
                       --report-path gitleaks.sarif \
                       --no-banner \
                       --redact \
                       --exit-code 0

      - name: Gitleaks sonuçlarını GitHub Security'e yükle
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif
