name: Test Stage Security

on:
  push:
    branches:
      - test
  pull_request:
    branches:
      - main

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  sast_semgrep:
    name: SAST - Semgrep
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Semgrep
        run: |
          pip install --upgrade pip
          pip install semgrep
          semgrep --config auto --error --sarif --output semgrep.sarif
      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif

  secrets_scan:
    name: Secrets Scan - Gitleaks
    runs-on: ubuntu-latest
    needs: sast_semgrep
    steps:
      - uses: actions/checkout@v4
      - uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --redact --exit-code 1

  trivy_scan:
    name: Container & FS Scan - Trivy
    runs-on: ubuntu-latest
    needs: [sast_semgrep, secrets_scan]
    steps:
      - uses: actions/checkout@v4

      - name: Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Image build et (varsayılan)
        if: ${{ hashFiles('Dockerfile') != '' }}
        run: docker build -t app-under-test .

      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

      - name: Trivy Image Scan
        if: ${{ hashFiles('Dockerfile') != '' }}
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: 'app-under-test'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

  dast_zap_baseline:
    name: DAST - ZAP Baseline
    runs-on: ubuntu-latest
    needs: trivy_scan
    if: ${{ hashFiles('Dockerfile') != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: App'i ayağa kaldır
        run: |
          docker build -t app-under-test .
          docker run -d --rm -p 3000:3000 --name app-under-test app-under-test
          for i in {1..30}; do
            if curl -sSf http://localhost:3000 >/dev/null 2>&1; then
              echo "Uygulama ayakta."
              exit 0
            fi
            echo "Uygulama bekleniyor..."
            sleep 5
          done
          echo "Uygulama başlamadı"; exit 1

      - name: ZAP Baseline Scan
        uses: ghcr.io/zaproxy/action-baseline@v0.13.0
        with:
          target: 'http://host.docker.internal:3000'
          cmd_options: '-a -I'

  security_gate:
    name: Test -> Main Security Gate
    runs-on: ubuntu-latest
    needs: [sast_semgrep, secrets_scan, trivy_scan, dast_zap_baseline]
    steps:
      - name: Gate sonucu
        run: |
          echo "Test -> Main için tüm güvenlik kontrolleri geçti."
